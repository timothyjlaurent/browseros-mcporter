#!/bin/bash
# Whisper-cpp transcription helper
# Handles format conversion and transcription

set -e

MODEL="${WHISPER_MODEL:-$HOME/.local/share/whisper/ggml-base.en.bin}"
WHISPER_BIN="${WHISPER_BIN:-/home/linuxbrew/.linuxbrew/Cellar/whisper-cpp/1.8.3/libexec/bin/whisper-cli}"

if [ $# -lt 1 ]; then
    echo "Usage: $0 <audio-file> [language]"
    echo "Example: $0 voice-memo.ogg"
    echo "Example: $0 interview.mp3 es"
    exit 1
fi

INPUT_FILE="$1"
LANG="${2:-en}"

if [ ! -f "$INPUT_FILE" ]; then
    echo "Error: File not found: $INPUT_FILE"
    exit 1
fi

if [ ! -f "$MODEL" ]; then
    echo "Error: Whisper model not found at $MODEL"
    echo "Download with: curl -L -o $MODEL 'https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en.bin'"
    exit 1
fi

# Convert to WAV if needed
FILE_EXT="${INPUT_FILE##*.}"
if [ "$FILE_EXT" != "wav" ]; then
    TEMP_WAV="/tmp/whisper-$$.wav"
    ffmpeg -i "$INPUT_FILE" -ar 16000 -ac 1 -c:a pcm_s16le "$TEMP_WAV" -y -loglevel error
    INPUT_FILE="$TEMP_WAV"
    CLEANUP=1
fi

# Transcribe
$WHISPER_BIN -m "$MODEL" -f "$INPUT_FILE" --language "$LANG" 2>&1 | grep -E '^\[' || true

# Cleanup temp file
if [ -n "$CLEANUP" ] && [ -f "$TEMP_WAV" ]; then
    rm -f "$TEMP_WAV"
fi
